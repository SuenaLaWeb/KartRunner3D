<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kart Runner 3D - Ultimate Pro</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        * { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; user-select: none; outline: none; }
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #000; touch-action: none; height: 100vh; width: 100vw; }
        
        #ui { position: absolute; inset: 0; color: white; z-index: 10; pointer-events: none; display: none; padding: env(safe-area-inset-top) 1rem 1rem 5rem; }
        .ui-element { pointer-events: auto; }
        
        #menu { position: fixed; inset: 0; background: linear-gradient(135deg, #1e3a8a, #9333ea, #db2777); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: white; }
        
        .btn { padding: 1rem 2rem; margin: 0.5rem; border-radius: 1rem; border: none; font-weight: 900; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.3); min-width: 40vw; max-width: 80vw; font-size: clamp(1rem, 5vw, 1.5rem); text-transform: uppercase; letter-spacing: 0.1em; pointer-events: auto; }
        .btn:active { transform: scale(0.95); opacity: 0.9; }
        .btn-penguin { background: #0ea5e9; color: #f8fafc; }
        .btn-fox { background: #f97316; color: #fff; }
        .btn-turtle { background: #22c55e; color: #fff; }
        
        #game-over, #pause-menu, #victory { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 200; color: white; padding: 1rem; }
        .stat-row { display: flex; justify-content: space-between; width: 90vw; max-width: 400px; padding: 0.8rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: clamp(1rem, 4vw, 1.2rem); }

        /* SEMÁFORO */
        #countdown-layer {
            position: fixed; inset: 0; z-index: 50; display: none; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.4);
        }
        .traffic-light-container {
            background: #111; padding: 1.5rem; border-radius: 1.5rem; border: 4px solid #333;
            display: flex; gap: 1rem; box-shadow: 0 0.8rem 2rem rgba(0,0,0,0.8);
        }
        .light-bulb {
            width: 4rem; height: 4rem; border-radius: 50%; background: #222;
            border: 2px solid #444; transition: all 0.1s;
        }
        .light-bulb.red-on { background: #ff0000; box-shadow: 0 0 3rem #ff0000; border-color: #ff5555; }
        .light-bulb.yellow-on { background: #ffcc00; box-shadow: 0 0 3rem #ffcc00; border-color: #ffee55; }
        .light-bulb.green-on { background: #00ff00; box-shadow: 0 0 4rem #00ff00; border-color: #55ff55; transform: scale(1.1); }

        #go-signal {
            position: absolute; font-size: clamp(4rem, 15vw, 8rem); font-weight: 900; font-style: italic; color: #fff;
            text-shadow: 0 0 1.5rem #00ff00; opacity: 0; transform: scale(0.5); 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }

        /* Controles móviles - más grandes y adaptados */
        #controls { 
            position: fixed; bottom: 1rem; left: 0; right: 0; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 1rem; z-index: 20; 
        }
        #gear-btn, #left-btn, #right-btn {
            background: #ffcc00; color: #000; 
            padding: clamp(1rem, 6vw, 1.5rem); 
            border-radius: 50%; font-weight: bold; 
            font-size: clamp(1.2rem, 5vw, 1.8rem); 
            min-width: clamp(3.5rem, 12vw, 5rem); 
            min-height: clamp(3.5rem, 12vw, 5rem); 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.4);
        }
        #left-btn, #right-btn { background: #00ff00; }

        /* Forzar portrait (vertical) ahora */
        @media (orientation: landscape) {
            body::before {
                content: "Gira tu dispositivo a vertical para jugar mejor.";
                position: fixed; inset: 0; background: rgba(0,0,0,0.9); 
                color: white; font-size: 2rem; display: flex; 
                align-items: center; justify-content: center; z-index: 999;
            }
            canvas, #ui, #controls { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="ui">
        <div class="absolute top-4 left-4 text-5xl font-black drop-shadow-2xl">
            <span id="timer">00:00</span>
        </div>
        <div class="absolute top-4 left-1/2 -translate-x-1/2 w-11/12 max-w-xs text-center">
            <div class="bg-slate-900/80 px-5 py-2 rounded-t-xl border-b border-white/20 text-xl font-black">
                Score: <span id="score">0</span>
            </div>
            <div class="bg-slate-800/80 px-5 py-1 rounded-b-xl text-lg">
                Hi-Score: <span id="hiScore">0</span>
            </div>
        </div>
        <div class="absolute top-4 right-4 ui-element flex space-x-3">
            <button class="bg-white/10 p-4 rounded-xl border border-white/20 active:bg-white/30" onclick="togglePause()">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="white"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
            <button class="bg-white/10 p-4 rounded-xl border border-white/20 active:bg-white/30" onclick="toggleBGM()">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="white"><path d="M3 9v6h4l5 5v-13l-5 5h-4zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
            </button>
        </div>
    </div>

    <!-- El resto del HTML (countdown-layer, menu, pause-menu, game-over, victory, controls) se mantiene igual que en tu versión anterior -->

    <script>
        // ... (todo el código de audio, variables, funciones createKart, createPilot, etc. se mantiene exactamente igual)

        function initScene(type) {
            scene = new THREE.Scene();
            const cfg = biomes[type];
            scene.background = new THREE.Color(cfg.sky);
            scene.fog = new THREE.Fog(cfg.sky, 150, 950);
            camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 2000);
            camera.position.set(0, 7, 14); camera.lookAt(0, 1, -5);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(20, 60, 40); scene.add(sun);
            const ground = new THREE.Mesh(new THREE.PlaneGeometry(4000, 4000), new THREE.MeshStandardMaterial({ color: cfg.ground }));
            ground.rotation.x = -Math.PI/2; scene.add(ground);
            
            // CARRETERA SIEMPRE GRIS OSCURO, independientemente del bioma
            const road = new THREE.Mesh(
                new THREE.PlaneGeometry(laneWidth*3.6, 6000),
                new THREE.MeshStandardMaterial({ color: 0x333333 })  // gris oscuro fijo
            );
            road.rotation.x = -Math.PI/2; road.position.y = 0.01; scene.add(road);

            // ... (el resto de initScene: líneas, kerbs, árboles, nubes, player, etc. igual)

            document.getElementById('hiScore').innerText = hiScore;
            lastTimestamp = performance.now();
            requestAnimationFrame(animate);
        }

        // ... (el resto del script igual: animate, controles táctiles, teclado, resize, etc.)

        // En resize, forzamos recalcular para que UI se adapte
        window.addEventListener('resize', () => { 
            if(camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight; 
                camera.updateProjectionMatrix(); 
                renderer.setSize(window.innerWidth, window.innerHeight); 
            }
        });

        // Ya no forzamos landscape, permitimos portrait
        // (quitamos el lock de landscape)

        window.addEventListener('load', playMenuFanfare);
    </script>
</body>
</html>